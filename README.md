### Описание директорий и файлов

- **bot/**: Основной пакет бота
  - `main.py`: Точка входа для запуска бота
  - `handlers.py`: Обработчики команд и сообщений
  - `config.py`: Конфигурационные настройки, включая загрузку переменных окружения
  - `utils.py`: Вспомогательные функции
  - `logging_config.py`: Настройка системы логирования
- **logs/**: Директория для хранения логов бота и истории диалога пользователя с ботом. Создается автоматически при запуске бота.
  - `bot.log`: Файл логов.
- **feedbacks/**: Директория для хранения отзывов пользователей. Создается автоматически при работе бота, после отправки отзыва пользователем.
  - `feedbacks.txt`: Файл с сохраненными отзывами.
- **save/**: Директория для хранения историй предыдущих диалогов с ботом.
  - `user_hash(user_id)_datetime/` - Создается автоматически после нажатия кнопки "Сбросить историю". Хранит логи бота и историю диалога.
- **requirements.txt**: Список зависимостей проекта.
- **.gitignore**: Файл, определяющий, какие файлы и директории Git должен игнорировать.

## Установка и Настройка

1. **Клонировать репозиторий:**

    ```bash
    git clone git@github.com:Zeldrizz/feelix_telegram_bot.git your_dir
    cd your_dir
    ```

2. **Создать и активировать виртуальное окружение, чтобы получить доступ к переменным из .env:**

    Можно через pyenv, например. Окружение нужно постоянно перезапускать
    после внесения изменений в файлы.
    ```bash
    pyenv deactivate
    pyenv acticate NAME
    ```

3. **Установить зависимости:**

    ```bash
    pip install --upgrade pip
    pip install -r requirements.txt
    ```

4. **Добавить себе на локалку файл `.env`:**

    - Создать файл `.env` в корне проекта.
    - Добавить в него необходимые переменные окружения (файл будет отправлен через телеграм).

5. **Добавить себе на локалку файл `.gitignore`:**

    ```.gitignore
    # Виртуальное окружение
    FEELIX_ASYNC_BOT/
    venv/
    env/
    .venv/
    .env/
    *.env

    # Логи
    logs/
    *.log

    # Файлы с отзывами
    feedbacks/
    feedbacks.txt

    # Сохраненные диалоги и логи
    save/

    # Компилированные файлы Python
    __pycache__/
    *.pyc
    *.pyo
    *.pyd

    # Настройки IDE
    .vscode/
    .idea/
    *.sublime-project
    *.sublime-workspace

    # Другие временные файлы
    *.swp
    *.swo
    *.tmp
    *.bak
    *.orig

    # Секретные файлы
    *.secret
    *.key
    *.pem```

## Запуск Бота

Убедиться, что виртуальное окружение активировано и файл `.env` настроен.

```bash
cd  bot
python3 main.py
```
---

Ниже представлено **подробное** описание двух ключевых модулей бота — **`handlers.py`** и **`utils.py`**. Их назначение, основные функции и логика приведены в разрезе отдельных блоков кода и сценариев использования.

---

# Описание **handlers.py**

Модуль `handlers.py` отвечает за **обработку** входящих команд и сообщений от пользователя, а также за основную бизнес-логику работы бота. В нем содержатся функции:

1. **Команды**:  
   - `/start`  
   - `/help`  
   - `/add_premium` и др.

2. **Главный обработчик текстовых сообщений**:  
   - Принимает все входящие сообщения, проверяет состояние пользователя, дневные лимиты и т.д.

3. **Переходы по состояниям**:  
   - Выбор пола (gender).
   - Оформление пробной подписки.
   - Оставление отзыва.
   - Очистка истории, просмотр отзывов и прочие действия.

4. **Интеграция** с внешним API (через функцию `get_groq_response`), в том числе ведение истории (добавление новых сообщений и ответы от бота).

Основные объекты и логика в `handlers.py`:

1. **Глобальные переменные:**
   - `user_states: Dict[int, Dict[str, Any]]` — словарь для хранения состояний пользователя, где ключ — `user_id`, а значение — внутренние флаги состояний и др.  
   - `PREMIUM_USERS` — загружаемый из файлов список/словарь с информацией о том, кто имеет статус Premium и до какого срока.  
   - `DAILY_USAGE` / `DAILY_LIMIT` — отвечает за дневные лимиты символов (если пользователь не премиум).  
   - И т.д.

2. **Функции команд**:  
   - `async def start(...)`: Обрабатывает `/start`, отправляет приветственное сообщение, устанавливает флаг `choosing_gender = True` и вызывает функцию `ask_user_gender(...)`.  
   - `async def help_command(...)`: Выдает подсказку по доступным командам/кнопкам.  
   - `async def add_premium_user(...)`: Команда для менеджера (MANAGER_USER_ID) — добавить пользователя в список Premium, действует 30 дней.

3. **Функция `async def handle_text(...)`:**  
   - **Самая главная** точка входа для всех **не-командных** сообщений.  
   - Содержит логику:
     1. Проверка, есть ли у пользователя выбранный пол (`gender`). Если нет, бот принуждает выбрать (`ask_user_gender`).
     2. Проверка, не находится ли пользователь в «пробной подписке» или в «оставлении отзыва» (stated by `user_states[user_id]["waiting_for_feedback"]`).
     3. Проверка, есть ли у пользователя Premium. Если да — никаких лимитов. Если нет — проверяем дневной лимит символов.  
   - Вызывает `process_user_message(...)`, если нет блокировок из-за превышения лимита для обычных пользователей.

4. **Функция `async def process_user_message(user_id, user_message, update, context) -> str`:**  
   - Обрабатывает «кнопки» главного меню: «Premium подписка», «Очистить историю», «Оставить отзыв» и т.д.  
   - Если это не кнопка из меню, вызывает `get_groq_response(...)` для генерации ответа от LLM.  
   - Возвращает строку ответа бота (или `None`, если это была служебная команда).

5. **Функция `async def get_groq_response(...) -> str`:**  
   - Формирует запрос к Cloudflare AI Gateway (Groq) с «историей диалога».  
   - Получает ответ от API, добавляет его в историю.  
   - Возвращает текст ответа.

6. **Функции для работы с полом пользователя:**  
   - `async def ask_user_gender(...)`: Запрашивает у пользователя выбор пола (отправляет кнопки «Мужской», «Женский», «Не хочу указывать»).  
   - `async def handle_gender_choice_inner(...)`: При нажатии на кнопку пола пользователь выходит из состояния `choosing_gender`, вызывается `set_user_gender`, а потом эмулируется сообщение «Привет» - для того чтобы бот начал диалог с пользователем.

7. **Дополнительные функции**:  
   - `async def handle_premium_subscription(...)` — отправляет информацию о статусе (дата окончания) или возможности оформления подписки.  
   - `async def present_free_trial_choice(...)` — показывает кнопки «Да, хочу!» / «Вернуться обратно» для пробной подписки.  
   - `error_handler(...)` — глобальный обработчик непредвиденных ошибок.

Таким образом, `handlers.py` объединяет в себе **все обработчики**, задаёт **логику состояний** пользователей, а также **управляет** дневными лимитами, историей переписки и передачей сообщений в LLM-ку.

---

# Описание **utils.py**

Файл `utils.py` содержит набор **вспомогательных функций** для корректной работы бота. Его задачи:

1. **Работа с файлами** (истории диалогов, логи, JSON-файлы с данными о пользователях).  
2. **Функции-хелперы** для записи логов, хэширования, архивации истории, чтения/записи каких-либо структур (premium_users, daily_usage, daily_limits и т.д.).

Рассмотрим основные функции (названия могут отличаться в зависимости от конечного кода):

1. **Функция `hash_data(data: Any, algorithm: str = 'sha256') -> str`:**  
   - Принимает произвольные данные, приводит к строке и возвращает хэш. Используется для анонимизации идентификаторов пользователей.

2. **Функция `get_user_history_path(user_id: int) -> str`:**  
   - Генерирует уникальный путь к файлу `conversation_history.json` для конкретного пользователя (используя хэш user_id).  
   - Если директория не существует, создает ее.

3. **Функция `load_user_history(user_id: int) -> List[Dict[str, str]]`:**  
   - Загружает JSON-файл с историей диалога для данного пользователя.  
   - Если файл отсутствует, создает историю «с нуля», добавляя `SYSTEM_PROMPT` и, при наличии, строку о поле пользователя.  

4. **Функция `save_user_history(user_id: int, history: List[Dict[str, str]]) -> None`:**  
   - Сериализует (в формате JSON) текущую историю и записывает в файл `conversation_history.json`.  

5. **Функция `archive_user_history(user_id: int) -> None`:**  
   - Архивирует старую историю (перемещает в директорию внутри `save/` с таймстемпом), а затем создает «новую» пустую.  
   - Вызывается при нажатии кнопки «Очистить историю» в главном меню.

6. **Функция `log_message(user_id: int, role: str, message: str) -> None`:**  
   - Пишет отдельный лог (текстовый файл `conversation_history.log`) с таймстемпом.  
   - Используется для более подробного ведения истории (помимо JSON, где хранится контекст).

7. **Функция `save_user_info(user_id: int, username: str) -> None`:**  
   - Сохраняет общую информацию о пользователе (ID, username, gender, free_trial_used) в файле `users.json`.  
   - Если пользователь уже есть, не перезаписывает или дозаписывает нужные поля (в зависимости от реализации).

8. **Функция `set_user_gender(user_id: int, gender: str) -> None`:**  
   - Устанавливает (обновляет) выбранный пол пользователя в `users.json`.  
   - Может создавать новую запись, если пользователя раньше не было в `users.json`.

9. **Функция `get_user_gender(user_id: int) -> str | None`:**  
   - Извлекает значение поля `gender` для данного пользователя.

10. **Функции работы с Premium**:  
    - `save_premium_users`, `load_premium_users` — сохраняют/загружают словарь премиум-пользователей и дат, до которых у них активна подписка.  

11. **Функции работы с дневными лимитами** (суточными):  
    - `load_daily_limits`, `save_daily_limits`, `load_daily_usage`, `save_daily_usage` — загружают и сохраняют JSON-файлы, где отслеживаются сроки блокировки или текущее число использованных символов.  

12. **Функции работы с пробной подпиской**:  
    - `get_free_trial_status`, `set_free_trial_status` — проверяют/устанавливают флаг `free_trial_used` в `users.json`.

Фактически, `utils.py` — это «**инструментарий**» низкоуровневых операций: чтения-записи файлов, архивации данных, манипуляций с JSON, логирования и т. п. Данный модуль не содержит логики взаимодействия с Telegram или внешними API напрямую (это удел `handlers.py`), зато **предоставляет** удобные функции для любых вспомогательных операций.

---

- **`handlers.py`**:  
  - Основной «мозг» бота: отвечает на команды и текстовые сообщения, управляет состояниями пользователя (выбор пола, оформление подписки, оставление отзыва), проверяет лимиты, вызывает утилиты для записи истории, запрашивает `get_groq_response` у Cloudflare AI Gateway.  
  - Содержит основные обработчики и функции, связанные с Telegram (например, `update.message.reply_text`).

- **`utils.py`**:  
  - «Инфраструктурные» функции: чтение/запись JSON, работа с логами, архивацией истории, функциями для Premium и пробной подписки, манипуляции с полом пользователя (`set_user_gender`, `get_user_gender`).  
  - Призван отделить чисто технические задачи (файловая система, хэширование) от логики бизнес-процессов.
